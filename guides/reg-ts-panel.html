---
layout: methods-guide
title: "Panel Data Analysis in R: Fixed & Random Effects"
title_zh: "R è¯­è¨€é¢æ¿æ•°æ®åˆ†æï¼šå›ºå®šæ•ˆåº”ä¸éšæœºæ•ˆåº”"
parent_title: "Time Series & Panel Data"
parent_title_zh: "æ—¶é—´åºåˆ—ä¸é¢æ¿æ•°æ®"
parent_url: "reg-timeseries.html"
bilingual: true
mathjax: false
---

<div style="background: linear-gradient(135deg, var(--parchment) 0%, var(--cream) 100%); padding: 32px 24px; border-radius: 4px; margin-bottom: 28px; border-left: 5px solid var(--gold);">
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
    <span style="font-family: var(--mono); font-size: 11px; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 1px;" data-lang="en">CODE WALKTHROUGH Â· GUIDE</span>
    <span style="font-family: var(--mono); font-size: 11px; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 1px;" data-lang="zh">ä»£ç æŒ‡å— Â· å®Œæ•´æ•™ç¨‹</span>
  </div>
  <h1 style="font-family: var(--serif); font-size: 36px; color: var(--ink); margin: 16px 0 8px 0; font-weight: 700;" data-lang="en">Panel Data Analysis in R</h1>
  <h1 style="font-family: var(--serif); font-size: 36px; color: var(--ink); margin: 16px 0 8px 0; font-weight: 700;" data-lang="zh">R è¯­è¨€é¢æ¿æ•°æ®åˆ†æ</h1>
  <p style="font-family: var(--sans); font-size: 17px; color: var(--ink-faded); margin: 0; font-weight: 400;" data-lang="en">Interactive visualization + complete code walkthrough: from raw data to publication-ready fixed effects estimates.</p>
  <p style="font-family: var(--sans); font-size: 17px; color: var(--ink-faded); margin: 0; font-weight: 400;" data-lang="zh">äº¤äº’å¼å¯è§†åŒ–åŠ å®Œæ•´ä»£ç ï¼šä»åŸå§‹æ•°æ®åˆ°å¯ä¾›å‘è¡¨çš„å›ºå®šæ•ˆåº”ä¼°è®¡ã€‚</p>
</div>

<!-- ============================================================================ -->
<!-- SECTION 1: WHY CAN'T WE JUST USE OLS? -->
<!-- ============================================================================ -->

<section style="margin-bottom: 40px;">
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="en">Section 1: Why Can't We Just Use OLS?</h2>
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="zh">ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨æ™®é€šæœ€å°äºŒä¹˜æ³•ï¼Ÿ</h2>

  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 12px 0;" data-lang="en">The Problem: Hidden Unit Differences</h3>
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 12px 0;" data-lang="zh">é—®é¢˜ï¼šéšè—çš„å•ä½å·®å¼‚</h3>

    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0 0 12px 0;" data-lang="en">Imagine you're studying whether trade openness increases democracy. You collect data on 50 countries over 20 years. If you just run OLS:</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0 0 12px 0;" data-lang="zh">å‡è®¾ä½ åœ¨ç ”ç©¶è´¸æ˜“å¼€æ”¾åº¦æ˜¯å¦èƒ½å¢åŠ æ°‘ä¸»æ°´å¹³ã€‚ä½ æ”¶é›†äº†50ä¸ªå›½å®¶20å¹´çš„æ•°æ®ã€‚å¦‚æœä½ åªæ˜¯è¿è¡Œæ™®é€šOLSï¼š</p>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code>democracy ~ trade_openness + gdp_per_capita</code></pre>

    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0;" data-lang="en">you're comparing countries that happen to be more open with less open countries. But open countries might also have stronger legal systems, better-educated populations, or longer democratic traditions. These unobserved factors influence both trade openness <strong>and</strong> democracy â€” this is <strong>omitted variable bias</strong>.</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0;" data-lang="zh">ä½ åœ¨æ¯”è¾ƒç¢°å·§æ›´å¼€æ”¾çš„å›½å®¶å’Œä¸å¤ªå¼€æ”¾çš„å›½å®¶ã€‚ä½†å¼€æ”¾çš„å›½å®¶å¯èƒ½ä¹Ÿæœ‰æ›´å¼ºçš„æ³•å¾‹ä½“ç³»ã€æ›´å—æ•™è‚²çš„äººå£æˆ–æ›´é•¿çš„æ°‘ä¸»ä¼ ç»Ÿã€‚è¿™äº›æœªè§‚å¯Ÿåˆ°çš„å› ç´ åŒæ—¶å½±å“è´¸æ˜“å¼€æ”¾åº¦<strong>å’Œ</strong>æ°‘ä¸»æ°´å¹³â€”â€”è¿™å°±æ˜¯<strong>é—æ¼å˜é‡åå·®</strong>ã€‚</p>
  </div>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 20px;">
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 12px 0;" data-lang="en">The Solution: Look Within Countries Over Time</h3>
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 12px 0;" data-lang="zh">è§£å†³æ–¹æ¡ˆï¼šè§‚å¯Ÿæ¯ä¸ªå›½å®¶éšæ—¶é—´çš„å˜åŒ–</h3>

    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0 0 12px 0;" data-lang="en"><strong>Fixed Effects regression</strong> answers a different question: "When a country's trade openness increases, does its democracy score increase?" You compare each country to <strong>itself in a different year</strong>, not to other countries. Since a country's legal system, culture, and education infrastructure don't change overnight, you've controlled for all time-invariant country characteristics.</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0 0 12px 0;" data-lang="zh"><strong>å›ºå®šæ•ˆåº”å›å½’</strong>å›ç­”çš„æ˜¯ä¸€ä¸ªä¸åŒçš„é—®é¢˜ï¼š"å½“ä¸€ä¸ªå›½å®¶çš„è´¸æ˜“å¼€æ”¾åº¦å¢åŠ æ—¶ï¼Œå®ƒçš„æ°‘ä¸»æ°´å¹³æ˜¯å¦ä¸Šå‡ï¼Ÿ"ä½ åœ¨æ¯”è¾ƒæ¯ä¸ªå›½å®¶<strong>åœ¨ä¸åŒå¹´ä»½çš„è‡ªèº«è¡¨ç°</strong>ï¼Œè€Œä¸æ˜¯ä¸å…¶ä»–å›½å®¶æ¯”è¾ƒã€‚ç”±äºä¸€ä¸ªå›½å®¶çš„æ³•å¾‹ä½“ç³»ã€æ–‡åŒ–å’Œæ•™è‚²åŸºç¡€è®¾æ–½ä¸ä¼šä¸€å¤œä¹‹é—´æ”¹å˜ï¼Œä½ å·²ç»æ§åˆ¶äº†æ‰€æœ‰ä¸éšæ—¶é—´å˜åŒ–çš„å›½å®¶ç‰¹å¾ã€‚</p>

    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0;" data-lang="en">This is why panel data with FE is so powerful â€” it solves the country-level confounding by design.</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0;" data-lang="zh">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¸¦æœ‰å›ºå®šæ•ˆåº”çš„é¢æ¿æ•°æ®å¦‚æ­¤å¼ºå¤§â€”â€”å®ƒä»è®¾è®¡ä¸Šè§£å†³äº†å›½å®¶çº§åˆ«çš„æ··æ·†ã€‚</p>
  </div>
</section>

<!-- ============================================================================ -->
<!-- SECTION 2: INTERACTIVE FE vs RE SIMULATOR -->
<!-- ============================================================================ -->

<section style="margin-bottom: 40px;">
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="en">Section 2: Interactive FE vs RE Simulator</h2>
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="zh">ç¬¬äºŒéƒ¨åˆ†ï¼šäº¤äº’å¼å›ºå®šæ•ˆåº”vséšæœºæ•ˆåº”æ¨¡æ‹Ÿå™¨</h2>

  <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0 0 20px 0;" data-lang="en"><strong>Adjust the sliders below</strong> to generate synthetic panel data and see how Pooled OLS, Fixed Effects, and Random Effects estimates differ. The true effect is always 1.0.</p>
  <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); line-height: 1.7; margin: 0 0 20px 0;" data-lang="zh"><strong>è°ƒæ•´ä¸‹é¢çš„æ»‘å—</strong>ç”Ÿæˆåˆæˆé¢æ¿æ•°æ®ï¼ŒæŸ¥çœ‹æ±‡æ€»OLSã€å›ºå®šæ•ˆåº”å’Œéšæœºæ•ˆåº”ä¼°è®¡å¦‚ä½•ä¸åŒã€‚çœŸå®æ•ˆåº”å§‹ç»ˆä¸º1.0ã€‚</p>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 24px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <label style="font-family: var(--sans); font-size: 14px; font-weight: 600; color: var(--ink); display: block; margin-bottom: 8px;" data-lang="en">Number of Units (N): <span id="nUnitsValue" style="color: var(--gold);">30</span></label>
        <label style="font-family: var(--sans); font-size: 14px; font-weight: 600; color: var(--ink);margin-bottom: 8px;" data-lang="zh">å•ä½æ•° (N): <span id="nUnitsValue_zh" style="color: var(--gold);">30</span></label>
        <input id="nUnitsSlider" type="range" min="10" max="100" value="30" step="5" style="width: 100%; cursor: pointer;">
        <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); margin: 6px 0 0 0;" data-lang="en">Countries in the panel</p>
        <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); margin: 6px 0 0 0;" data-lang="zh">é¢æ¿ä¸­çš„å›½å®¶æ•°</p>
      </div>
      <div>
        <label style="font-family: var(--sans); font-size: 14px; font-weight: 600; color: var(--ink); display: block; margin-bottom: 8px;" data-lang="en">Time Periods (T): <span id="tPeriodsValue" style="color: var(--gold);">15</span></label>
        <label style="font-family: var(--sans); font-size: 14px; font-weight: 600; color: var(--ink);margin-bottom: 8px;" data-lang="zh">æ—¶æœŸæ•° (T): <span id="tPeriodsValue_zh" style="color: var(--gold);">15</span></label>
        <input id="tPeriodsSlider" type="range" min="5" max="30" value="15" step="1" style="width: 100%; cursor: pointer;">
        <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); margin: 6px 0 0 0;" data-lang="en">Years of data</p>
        <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); margin: 6px 0 0 0;" data-lang="zh">æ•°æ®å¹´ä»½</p>
      </div>
    </div>

    <div>
      <label style="font-family: var(--sans); font-size: 14px; font-weight: 600; color: var(--ink); display: block; margin-bottom: 8px;" data-lang="en">Unit Effect Correlation with X: <span id="corrValue" style="color: var(--gold);">0.8</span></label>
      <label style="font-family: var(--sans); font-size: 14px; font-weight: 600; color: var(--ink);margin-bottom: 8px;" data-lang="zh">å•ä½æ•ˆåº”ä¸Xçš„ç›¸å…³æ€§: <span id="corrValue_zh" style="color: var(--gold);">0.8</span></label>
      <input id="corrSlider" type="range" min="0" max="1" value="0.8" step="0.1" style="width: 100%; cursor: pointer;">
      <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); margin: 6px 0 0 0;" data-lang="en">Higher = more omitted variable bias in Pooled OLS</p>
      <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); margin: 6px 0 0 0;" data-lang="zh">è¶Šé«˜=æ±‡æ€»OLSä¸­è¶Šå¤šé—æ¼å˜é‡åå·®</p>
    </div>

    <button id="generateBtn" style="margin-top: 16px; padding: 10px 20px; background-color: var(--gold); color: var(--ink); border: none; border-radius: 3px; font-family: var(--sans); font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.3s;" data-lang="en">Generate Data & Run Regression</button>
    <button id="generateBtn_zh" style="margin-top: 16px; padding: 10px 20px; background-color: var(--gold); color: var(--ink); border: none; border-radius: 3px; font-family: var(--sans); font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.3s;" data-lang="zh">ç”Ÿæˆæ•°æ®å¹¶è¿è¡Œå›å½’</button>
  </div>

  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px;">
    <canvas id="simulatorChart" style="max-height: 400px;"></canvas>
    <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); text-align: center; margin: 12px 0 0 0;" data-lang="en">Regression Estimates (dotted line = true effect of 1.0)</p>
    <p style="font-family: var(--mono); font-size: 12px; color: var(--ink-faded); text-align: center; margin: 12px 0 0 0;" data-lang="zh">å›å½’ä¼°è®¡ï¼ˆè™šçº¿=çœŸå®æ•ˆåº”1.0ï¼‰</p>
  </div>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 20px;">
    <h3 style="font-family: var(--sans); font-size: 15px; color: var(--ink); font-weight: 600; margin: 0 0 12px 0;" data-lang="en">Simulation Insights</h3>
    <h3 style="font-family: var(--sans); font-size: 15px; color: var(--ink); font-weight: 600; margin: 0 0 12px 0;" data-lang="zh">æ¨¡æ‹Ÿè§è§£</h3>

    <ul style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.8; margin: 0; padding-left: 24px;">
      <li data-lang="en"><strong>High correlation (slider near 1):</strong> Pooled OLS is heavily biased because unit effects are correlated with X. FE and RE track the true effect. FE gives the right answer regardless.</li>
      <li data-lang="zh"><strong>é«˜ç›¸å…³æ€§ï¼ˆæ»‘å—æ¥è¿‘1ï¼‰ï¼š</strong>æ±‡æ€»OLSå› ä¸ºå•ä½æ•ˆåº”ä¸Xç›¸å…³è€Œä¸¥é‡åå·®ã€‚å›ºå®šæ•ˆåº”å’Œéšæœºæ•ˆåº”æ¥è¿‘çœŸå®æ•ˆåº”ã€‚æ— è®ºå¦‚ä½•ï¼Œå›ºå®šæ•ˆåº”éƒ½ç»™å‡ºæ­£ç¡®ç­”æ¡ˆã€‚</li>

      <li style="margin-top: 12px;" data-lang="en"><strong>Low correlation (slider near 0):</strong> Pooled OLS improves. RE becomes more efficient (narrower confidence intervals) because the uncorrelated assumption holds better. But FE is still unbiased.</li>
      <li style="margin-top: 12px;" data-lang="zh"><strong>ä½ç›¸å…³æ€§ï¼ˆæ»‘å—æ¥è¿‘0ï¼‰ï¼š</strong>æ±‡æ€»OLSæ”¹å–„ã€‚éšæœºæ•ˆåº”å˜å¾—æ›´æœ‰æ•ˆç‡ï¼ˆæ›´çª„çš„ç½®ä¿¡åŒºé—´ï¼‰ï¼Œå› ä¸ºä¸ç›¸å…³å‡è®¾æ›´å¥½åœ°æ»¡è¶³ã€‚ä½†å›ºå®šæ•ˆåº”ä»ç„¶æ— åã€‚</li>

      <li style="margin-top: 12px;" data-lang="en"><strong>Rule of thumb:</strong> When in doubt, use FE. It's robust to the FE/RE choice even if the data was generated under the RE assumption.</li>
      <li style="margin-top: 12px;" data-lang="zh"><strong>ç»éªŒæ³•åˆ™ï¼š</strong>æœ‰ç–‘é—®æ—¶ï¼Œä½¿ç”¨å›ºå®šæ•ˆåº”ã€‚å³ä½¿æ•°æ®æ˜¯åœ¨éšæœºæ•ˆåº”å‡è®¾ä¸‹ç”Ÿæˆçš„ï¼Œå®ƒå¯¹å›ºå®šæ•ˆåº”/éšæœºæ•ˆåº”é€‰æ‹©ä¹Ÿæ˜¯ç¨³å¥çš„ã€‚</li>
    </ul>
  </div>
</section>

<!-- ============================================================================ -->
<!-- SECTION 3: R CODE WALKTHROUGH -->
<!-- ============================================================================ -->

<section style="margin-bottom: 40px;">
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="en">Section 3: Complete R Code Walkthrough</h2>
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="zh">ç¬¬ä¸‰éƒ¨åˆ†ï¼šRä»£ç å®Œæ•´æ¼”ç»ƒ</h2>

  <!-- Subsection 3.1: Setup -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.1: Setup & Data Preparation</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.1ï¼šè®¾ç½®å’Œæ•°æ®å‡†å¤‡</h3>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># Install packages (run once)
install.packages(c("plm", "fixest", "tidyverse", "sandwich"))

# Load libraries
library(plm)
library(fixest)
library(tidyverse)
library(sandwich)</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>About these packages:</strong></p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>å…³äºè¿™äº›åŒ…ï¼š</strong></p>
      <ul style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 8px 0 0 0; padding-left: 20px;">
        <li><code>plm</code> â€” classic panel data package, good for teaching</li>
        <li data-lang="zh"><code>plm</code> â€” ç»å…¸é¢æ¿æ•°æ®åŒ…ï¼Œé€‚åˆæ•™å­¦</li>
        <li><code>fixest</code> â€” fast, modern, publication-ready tables. Recommended for real projects.</li>
        <li data-lang="zh"><code>fixest</code> â€” å¿«é€Ÿã€ç°ä»£ã€å¯ä¾›å‘è¡¨çš„è¡¨æ ¼ã€‚æ¨èç”¨äºçœŸå®é¡¹ç›®ã€‚</li>
        <li><code>sandwich</code> â€” robust covariance estimators for clustered standard errors</li>
        <li data-lang="zh"><code>sandwich</code> â€” ç”¨äºèšç±»æ ‡å‡†è¯¯çš„ç¨³å¥åæ–¹å·®ä¼°è®¡å™¨</li>
      </ul>
    </div>
  </div>

  <!-- Subsection 3.2: Declare Panel Structure -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.2: Declare Panel Structure</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.2ï¼šå£°æ˜é¢æ¿ç»“æ„</h3>

    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.6; margin: 0 0 12px 0;" data-lang="en">Tell R which column identifies units and which identifies time periods:</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.6; margin: 0 0 12px 0;" data-lang="zh">å‘Šè¯‰Rå“ªä¸€åˆ—è¯†åˆ«å•ä½ï¼Œå“ªä¸€åˆ—è¯†åˆ«æ—¶é—´å‘¨æœŸï¼š</p>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># For plm package
pdata <- pdata.frame(df, index = c("country", "year"))

# Check balance (are all units observed in all years?)
is.pbalanced(pdata)
#> TRUE

# Check dimensions
pdim(pdata)
#> Balanced Panel: n = 50, T = 20, N = 1000
# n = number of units, T = number of time periods, N = total obs</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>Why this matters:</strong> Declaring the panel structure tells R to respect the clustering when computing standard errors. Without it, R treats all 1000 observations as independent (wrong!).</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>ä¸ºä»€ä¹ˆé‡è¦ï¼š</strong>å£°æ˜é¢æ¿ç»“æ„å‘Šè¯‰Råœ¨è®¡ç®—æ ‡å‡†è¯¯æ—¶å°Šé‡èšç±»ã€‚æ²¡æœ‰å®ƒï¼ŒRä¼šæŠŠæ‰€æœ‰1000ä¸ªè§‚æµ‹å€¼è§†ä¸ºç‹¬ç«‹çš„ï¼ˆé”™è¯¯ï¼ï¼‰ã€‚</p>
    </div>
  </div>

  <!-- Subsection 3.3: Pooled OLS -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.3: Pooled OLS (Baseline, Usually Wrong)</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.3ï¼šæ±‡æ€»OLSï¼ˆåŸºçº¿ï¼Œé€šå¸¸ä¸æ­£ç¡®ï¼‰</h3>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># Pooled OLS: treats all obs as independent (ignores panel structure)
model_pooled <- plm(democracy ~ trade_openness + gdp_log + population_log,
                    data = pdata, model = "pooling")
summary(model_pooled)</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>What's wrong:</strong> Pooled OLS ignores that each country is observed multiple times. It treats the China 2000-China 2001 change the same as China-France. If unit effects (e.g., "democracy-friendly institutions") are correlated with your predictor X (e.g., "trade openness"), the coefficient on X is biased.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>é—®é¢˜æ‰€åœ¨ï¼š</strong>æ±‡æ€»OLSå¿½è§†æ¯ä¸ªå›½å®¶è¢«å¤šæ¬¡è§‚å¯Ÿçš„äº‹å®ã€‚å®ƒæŠŠä¸­å›½2000-ä¸­å›½2001çš„å˜åŒ–è§†ä¸ºä¸­å›½-æ³•å›½çš„æ¯”è¾ƒã€‚å¦‚æœå•ä½æ•ˆåº”ï¼ˆä¾‹å¦‚"æ°‘ä¸»å‹å¥½æœºæ„"ï¼‰ä¸ä½ çš„é¢„æµ‹å˜é‡Xï¼ˆä¾‹å¦‚"è´¸æ˜“å¼€æ”¾åº¦"ï¼‰ç›¸å…³ï¼Œåˆ™Xçš„ç³»æ•°æœ‰åã€‚</p>
    </div>
  </div>

  <!-- Subsection 3.4: Fixed Effects -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.4: Fixed Effects (The Gold Standard)</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.4ï¼šå›ºå®šæ•ˆåº”ï¼ˆé»„é‡‘æ ‡å‡†ï¼‰</h3>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># One-way FE: unit fixed effects (remove between-unit variation)
model_fe_1way <- plm(democracy ~ trade_openness + gdp_log + population_log,
                     data = pdata, model = "within", effect = "individual")
summary(model_fe_1way)

# Two-way FE: unit + time FE (recommended â€” controls time trends)
model_fe_2way <- plm(democracy ~ trade_openness + gdp_log + population_log,
                     data = pdata, model = "within", effect = "twoways")
summary(model_fe_2way)

# Even faster: use fixest (recommended for large datasets)
model_fixest <- feols(democracy ~ trade_openness + gdp_log + population_log
                      | country + year,  # unit + time FE
                      data = df)
summary(model_fixest)</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>How it works:</strong> FE removes all between-country variation by either (1) including a dummy for each country or (2) demeaning all variables within each country. What remains is purely <strong>within-unit variation over time</strong>. Since a country's unobserved institutions don't change in 1 year, FE controls for all unit-level confounders automatically.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>å·¥ä½œåŸç†ï¼š</strong>å›ºå®šæ•ˆåº”é€šè¿‡(1)ä¸ºæ¯ä¸ªå›½å®¶åŒ…æ‹¬è™šæ‹Ÿå˜é‡æˆ–(2)åœ¨æ¯ä¸ªå›½å®¶å†…å¯¹æ‰€æœ‰å˜é‡è¿›è¡Œå»å‡å€¼æ¥åˆ é™¤æ‰€æœ‰å›½å®¶é—´çš„å˜å¼‚ã€‚å‰©ä¸‹çš„çº¯ç²¹æ˜¯<strong>å•ä½å†…éšæ—¶é—´çš„å˜å¼‚</strong>ã€‚ç”±äºå›½å®¶çš„æœªè§‚å¯Ÿæœºæ„åœ¨1å¹´å†…ä¸ä¼šæ”¹å˜ï¼Œå›ºå®šæ•ˆåº”è‡ªåŠ¨æ§åˆ¶æ‰€æœ‰å•ä½çº§åˆ«çš„æ··æ·†å› å­ã€‚</p>
    </div>

    <div style="background: var(--cream); padding: 12px 16px; border-radius: 3px; margin-top: 12px; border-left: 4px solid var(--gold);">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); font-weight: 600; margin: 0;" data-lang="en">ğŸ’¡ Key insight:</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); font-weight: 600; margin: 0;" data-lang="zh">ğŸ’¡ å…³é”®è§è§£ï¼š</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 6px 0 0 0; line-height: 1.6;" data-lang="en">Use <strong>two-way FE</strong> (unit + time) by default. Time FE absorbs global shocks (2008 financial crisis, COVID) that affect all countries equally. Without it, you might falsely attribute these common trends to your predictor.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 6px 0 0 0; line-height: 1.6;" data-lang="zh">é»˜è®¤ä½¿ç”¨<strong>åŒå‘å›ºå®šæ•ˆåº”</strong>ï¼ˆå•ä½+æ—¶é—´ï¼‰ã€‚æ—¶é—´å›ºå®šæ•ˆåº”å¸æ”¶å½±å“æ‰€æœ‰å›½å®¶çš„å…¨çƒå†²å‡»ï¼ˆ2008å¹´é‡‘èå±æœºã€COVIDï¼‰ã€‚æ²¡æœ‰å®ƒï¼Œä½ å¯èƒ½ä¼šé”™è¯¯åœ°å°†è¿™äº›å…±åŒè¶‹åŠ¿å½’å’äºä½ çš„é¢„æµ‹å˜é‡ã€‚</p>
    </div>
  </div>

  <!-- Subsection 3.5: Random Effects -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.5: Random Effects (Stronger Assumptions, Higher Efficiency)</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.5ï¼šéšæœºæ•ˆåº”ï¼ˆæ›´å¼ºå‡è®¾ï¼Œæ›´é«˜æ•ˆç‡ï¼‰</h3>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># Random effects: assumes unit effects are uncorrelated with predictors
model_re <- plm(democracy ~ trade_openness + gdp_log + population_log,
                data = pdata, model = "random")
summary(model_re)

# Compare to FE
coef(model_fe_2way)
coef(model_re)</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>FE vs RE trade-off:</strong> RE is more efficient (narrower confidence intervals) because it uses both between- and within-unit variation. But it requires the assumption that unit effects are uncorrelated with your predictors. FE is conservative â€” it sacrifices efficiency for robustness. FE remains unbiased even if the RE assumption is violated.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>å›ºå®šæ•ˆåº”vséšæœºæ•ˆåº”æƒè¡¡ï¼š</strong>éšæœºæ•ˆåº”å› ä¸ºä½¿ç”¨å•ä½é—´å’Œå•ä½å†…å˜å¼‚è€Œæ›´æœ‰æ•ˆç‡ï¼ˆæ›´çª„çš„ç½®ä¿¡åŒºé—´ï¼‰ã€‚ä½†å®ƒéœ€è¦å•ä½æ•ˆåº”ä¸é¢„æµ‹å˜é‡æ— å…³çš„å‡è®¾ã€‚å›ºå®šæ•ˆåº”æ˜¯ä¿å®ˆçš„â€”â€”å®ƒä¸ºäº†ç¨³å¥æ€§è€Œç‰ºç‰²æ•ˆç‡ã€‚å³ä½¿éšæœºæ•ˆåº”å‡è®¾è¢«è¿åï¼Œå›ºå®šæ•ˆåº”ä»ç„¶æ— åã€‚</p>
    </div>

    <div style="background: var(--cream); padding: 12px 16px; border-radius: 3px; margin-top: 12px; border-left: 4px solid var(--gold);">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); font-weight: 600; margin: 0;" data-lang="en">ğŸ“‹ Rule of thumb:</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); font-weight: 600; margin: 0;" data-lang="zh">ğŸ“‹ ç»éªŒæ³•åˆ™ï¼š</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 6px 0 0 0; line-height: 1.6;" data-lang="en">Use FE unless you have strong theoretical reasons to believe unit effects are uncorrelated with your predictors (e.g., cross-sectional study where units are randomly assigned).</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 6px 0 0 0; line-height: 1.6;" data-lang="zh">é™¤éä½ æœ‰å¼ºæœ‰åŠ›çš„ç†è®ºåŸå› ç›¸ä¿¡å•ä½æ•ˆåº”ä¸é¢„æµ‹å˜é‡æ— å…³ï¼ˆä¾‹å¦‚ï¼Œå•ä½è¢«éšæœºåˆ†é…çš„æ¨ªæˆªé¢ç ”ç©¶ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨å›ºå®šæ•ˆåº”ã€‚</p>
    </div>
  </div>

  <!-- Subsection 3.6: Hausman Test -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.6: Hausman Test (FE vs RE Statistical Choice)</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.6ï¼šHausmanæ£€éªŒï¼ˆå›ºå®šæ•ˆåº”vséšæœºæ•ˆåº”ç»Ÿè®¡é€‰æ‹©ï¼‰</h3>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># Hausman test: H0 is that RE assumption holds (effects uncorrelated with X)
hausman_result <- phtest(model_fe_2way, model_re)
print(hausman_result)

# Interpretation:
# p-value < 0.05: Reject H0 â†’ effects ARE correlated with X â†’ use FE
# p-value > 0.05: Fail to reject H0 â†’ RE assumption seems OK â†’ could use either</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>Important caveat:</strong> The Hausman test is not always reliable, especially with small N or many time periods. Many economists ignore it and just use FE as the default. This is reasonable â€” FE is the safer choice.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>é‡è¦æ³¨æ„ï¼š</strong>Hausmanæ£€éªŒå¹¶ä¸æ€»æ˜¯å¯é çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨Nè¾ƒå°æˆ–æ—¶é—´å‘¨æœŸè¾ƒå¤šæ—¶ã€‚è®¸å¤šç»æµå­¦å®¶å¿½è§†å®ƒï¼Œåªæ˜¯å°†å›ºå®šæ•ˆåº”ä½œä¸ºé»˜è®¤é€‰æ‹©ã€‚è¿™æ˜¯åˆç†çš„â€”â€”å›ºå®šæ•ˆåº”æ˜¯æ›´å®‰å…¨çš„é€‰æ‹©ã€‚</p>
    </div>
  </div>

  <!-- Subsection 3.7: Clustered Standard Errors -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.7: Clustered Standard Errors (Essential!)</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.7ï¼šèšç±»æ ‡å‡†è¯¯ï¼ˆè‡³å…³é‡è¦ï¼ï¼‰</h3>

    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.6; margin: 0 0 12px 0;" data-lang="en">Standard errors from panel regression are usually wrong because observations within units are highly correlated. Always cluster at the unit level:</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.6; margin: 0 0 12px 0;" data-lang="zh">é¢æ¿å›å½’çš„æ ‡å‡†è¯¯é€šå¸¸æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºå•ä½å†…çš„è§‚æµ‹å€¼é«˜åº¦ç›¸å…³ã€‚å§‹ç»ˆåœ¨å•ä½çº§åˆ«èšç±»ï¼š</p>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># Using fixest (clusters by default â€” highly recommended)
model_clustered <- feols(democracy ~ trade_openness + gdp_log + population_log
                         | country + year,
                         data = df,
                         cluster = ~country)  # cluster at unit level
summary(model_clustered)

# Using plm + sandwich
se_clustered <- vcovHC(model_fe_2way, type = "HC1", cluster = "group")
coeftest(model_fe_2way, vcov = se_clustered)

# Publication-ready table
etable(model_clustered, tex = TRUE)</code></pre>

    <div style="background: var(--cream); padding: 12px 16px; border-radius: 3px; margin-top: 12px; border-left: 4px solid var(--gold);">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); font-weight: 600; margin: 0;" data-lang="en">âš ï¸ Most common error:</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); font-weight: 600; margin: 0;" data-lang="zh">âš ï¸ æœ€å¸¸è§çš„é”™è¯¯ï¼š</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 6px 0 0 0; line-height: 1.6;" data-lang="en">Reporting standard OLS standard errors without clustering. This makes t-statistics too large and p-values too small, giving false confidence. In panel data, always cluster.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 6px 0 0 0; line-height: 1.6;" data-lang="zh">æŠ¥å‘Šæœªèšç±»çš„æ ‡å‡†OLSæ ‡å‡†è¯¯ã€‚è¿™ä½¿tç»Ÿè®¡é‡è¿‡å¤§ï¼Œpå€¼è¿‡å°ï¼Œç»™äºˆè™šå‡ç½®ä¿¡ã€‚åœ¨é¢æ¿æ•°æ®ä¸­ï¼Œæ€»æ˜¯èšç±»ã€‚</p>
    </div>
  </div>

  <!-- Subsection 3.8: Event Study -->
  <div style="background: var(--cream); padding: 24px; border-radius: 6px; margin-bottom: 24px; border-top: 4px solid var(--gold);">
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="en">3.8: Event Study (When Did the Effect Kick In?)</h3>
    <h3 style="font-family: var(--sans); font-size: 17px; color: var(--ink); font-weight: 600; margin: 0 0 16px 0;" data-lang="zh">3.8ï¼šäº‹ä»¶ç ”ç©¶ï¼ˆæ•ˆåº”ä½•æ—¶å¼€å§‹ï¼Ÿï¼‰</h3>

    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.6; margin: 0 0 12px 0;" data-lang="en">If your policy or treatment rolls out at different times across units, you can estimate effects relative to treatment adoption:</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.6; margin: 0 0 12px 0;" data-lang="zh">å¦‚æœä½ çš„æ”¿ç­–æˆ–å¤„ç†åœ¨ä¸åŒæ—¶é—´è·¨å•ä½æ¨å‡ºï¼Œä½ å¯ä»¥ä¼°è®¡ç›¸å¯¹äºå¤„ç†é‡‡ç”¨çš„æ•ˆåº”ï¼š</p>

    <pre style="background: var(--parchment); padding: 16px; border-radius: 3px; font-family: var(--mono); font-size: 13px; overflow-x: auto; line-height: 1.6; margin: 12px 0"><code># Create a "relative time" variable: years relative to treatment
# Example: if country i adopted policy in year 2005
# then in 2003: relative_time = -2
#     in 2005: relative_time = 0
#     in 2007: relative_time = 2

# Event study regression
model_event <- feols(outcome ~ i(relative_time, treated, ref = -1)
                     | country + year,
                     data = df,
                     cluster = ~country)

summary(model_event)

# Visualize treatment effects over time
iplot(model_event,
      main = "Event Study: Treatment Effects Relative to Adoption",
      xlab = "Years Relative to Policy Adoption")

# Interpretation:
# - Coefficients before year 0: should be close to 0 (parallel trends)
# - Coefficients after year 0: treatment effect at each lag
# - If large effects pre-treatment â†’ parallel trends assumption violated</code></pre>

    <div style="background: var(--parchment); padding: 12px 16px; border-radius: 3px; margin-top: 12px;">
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en"><strong>When to use this:</strong> When you have a <strong>staggered treatment</strong> (e.g., countries adopted carbon pricing at different times). Event study lets you test the <strong>parallel trends assumption</strong> â€” if treated and control units moved together before treatment, it strengthens causal inference.</p>
      <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh"><strong>ä½•æ—¶ä½¿ç”¨ï¼š</strong>å½“ä½ æœ‰<strong>é”™å¼€çš„å¤„ç†</strong>ï¼ˆä¾‹å¦‚ï¼Œå›½å®¶åœ¨ä¸åŒæ—¶é—´é‡‡å–ç¢³å®šä»·ï¼‰ã€‚äº‹ä»¶ç ”ç©¶è®©ä½ æµ‹è¯•<strong>å¹³è¡Œè¶‹åŠ¿å‡è®¾</strong>â€”â€”å¦‚æœå¤„ç†å•ä½å’Œå¯¹ç…§å•ä½åœ¨å¤„ç†å‰ä¸€èµ·ç§»åŠ¨ï¼Œå®ƒåŠ å¼ºå› æœæ¨è®ºã€‚</p>
    </div>
  </div>
</section>

<!-- ============================================================================ -->
<!-- SECTION 4: COMMON MISTAKES -->
<!-- ============================================================================ -->

<section style="margin-bottom: 40px;">
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="en">Section 4: Common Mistakes (Don't Make These!)</h2>
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="zh">ç¬¬å››éƒ¨åˆ†ï¼šå¸¸è§é”™è¯¯ï¼ˆåˆ«çŠ¯è¿™äº›ï¼ï¼‰</h2>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid var(--red);">
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="en">âŒ Mistake 1: Not Clustering Standard Errors</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="zh">âŒ é”™è¯¯1ï¼šæœªèšç±»æ ‡å‡†è¯¯</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en">Panel observations within the same unit are correlated (autocorrelated errors). If you report standard OLS standard errors, your t-statistics are too large and p-values too small â€” you'll find spurious significance.</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh">åŒä¸€å•ä½å†…çš„é¢æ¿è§‚æµ‹å€¼ç›¸å…³ï¼ˆè‡ªç›¸å…³è¯¯å·®ï¼‰ã€‚å¦‚æœä½ æŠ¥å‘Šæ ‡å‡†OLSæ ‡å‡†è¯¯ï¼Œä½ çš„tç»Ÿè®¡é‡å¤ªå¤§ï¼Œpå€¼å¤ªå°â€”â€”ä½ ä¼šå‘ç°è™šå‡çš„æ˜¾è‘—æ€§ã€‚</p>
    <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 8px 0 0 0; line-height: 1.6;" data-lang="en"><strong>Fix:</strong> Always use <code style="background: var(--parchment); padding: 2px 6px; border-radius: 2px;">cluster = ~unit_id</code> in fixest or <code style="background: var(--parchment); padding: 2px 6px; border-radius: 2px;">vcovHC(..., cluster = "group")</code> in plm.</p>
    <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 8px 0 0 0; line-height: 1.6;" data-lang="zh"><strong>ä¿®å¤ï¼š</strong>åœ¨fixestä¸­å§‹ç»ˆä½¿ç”¨<code style="background: var(--parchment); padding: 2px 6px; border-radius: 2px;">cluster = ~unit_id</code>æˆ–åœ¨plmä¸­ä½¿ç”¨<code style="background: var(--parchment); padding: 2px 6px; border-radius: 2px;">vcovHC(..., cluster = "group")</code>ã€‚</p>
  </div>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid var(--red);">
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="en">âŒ Mistake 2: Including Time-Invariant Variables in FE</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="zh">âŒ é”™è¯¯2ï¼šåœ¨å›ºå®šæ•ˆåº”ä¸­åŒ…å«ä¸éšæ—¶é—´å˜åŒ–çš„å˜é‡</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en">Fixed effects removes all unit-level variation, which means any variable that doesn't change within units will be collinear with the unit dummy. R will drop it automatically.</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh">å›ºå®šæ•ˆåº”å»é™¤æ‰€æœ‰å•ä½çº§å˜å¼‚ï¼Œè¿™æ„å‘³ç€ä»»ä½•ä¸åœ¨å•ä½å†…å˜åŒ–çš„å˜é‡éƒ½å°†ä¸å•ä½è™šæ‹Ÿå˜é‡å…±çº¿ã€‚Rä¼šè‡ªåŠ¨åˆ é™¤å®ƒã€‚</p>
    <pre style="background: var(--cream); padding: 12px; border-radius: 3px; font-family: var(--mono); font-size: 12px; margin: 8px 0;" data-lang="en"><code># Don't do this:
model_bad <- feols(outcome ~ education_level | country + year, data = df)
# education_level doesn't change within countries, so it gets dropped</code></pre>
    <pre style="background: var(--cream); padding: 12px; border-radius: 3px; font-family: var(--mono); font-size: 12px; margin: 8px 0;" data-lang="zh"><code># ä¸è¦è¿™æ ·åšï¼š
model_bad <- feols(outcome ~ education_level | country + year, data = df)
# education_levelåœ¨å›½å®¶å†…ä¸å˜åŒ–ï¼Œæ‰€ä»¥å®ƒä¼šè¢«åˆ é™¤</code></pre>
    <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 8px 0 0 0; line-height: 1.6;" data-lang="en"><strong>Fix:</strong> Use RE if you want to estimate effects of time-invariant variables. Or use Mundlak approach (add group means as controls).</p>
    <p style="font-family: var(--sans); font-size: 13px; color: var(--ink); margin: 8px 0 0 0; line-height: 1.6;" data-lang="zh"><strong>ä¿®å¤ï¼š</strong>å¦‚æœè¦ä¼°è®¡ä¸éšæ—¶é—´å˜åŒ–å˜é‡çš„æ•ˆåº”ï¼Œä½¿ç”¨éšæœºæ•ˆåº”ã€‚æˆ–ä½¿ç”¨Mundlakæ–¹æ³•ï¼ˆæ·»åŠ ç»„å‡å€¼ä½œä¸ºæ§åˆ¶ï¼‰ã€‚</p>
  </div>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid var(--red);">
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="en">âŒ Mistake 3: Forgetting Time Fixed Effects</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="zh">âŒ é”™è¯¯3ï¼šå¿˜è®°æ—¶é—´å›ºå®šæ•ˆåº”</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en">Global shocks (recessions, pandemics, policy changes) affect all units simultaneously. If you don't control for these common trends with time FE, you might falsely attribute them to your predictor.</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh">å…¨çƒå†²å‡»ï¼ˆè¡°é€€ã€æµè¡Œç—…ã€æ”¿ç­–å˜åŒ–ï¼‰åŒæ—¶å½±å“æ‰€æœ‰å•ä½ã€‚å¦‚æœä½ ä¸ç”¨æ—¶é—´å›ºå®šæ•ˆåº”æ§åˆ¶è¿™äº›å…±åŒè¶‹åŠ¿ï¼Œä½ å¯èƒ½ä¼šé”™è¯¯åœ°å°†å®ƒä»¬å½’å’äºä½ çš„é¢„æµ‹å˜é‡ã€‚</p>
    <pre style="background: var(--cream); padding: 12px; border-radius: 3px; font-family: var(--mono); font-size: 12px; margin: 8px 0;" data-lang="en"><code># Good: two-way FE
feols(outcome ~ x | country + year, data = df)

# Bad: only unit FE (misses global trends)
feols(outcome ~ x | country, data = df)</code></pre>
    <pre style="background: var(--cream); padding: 12px; border-radius: 3px; font-family: var(--mono); font-size: 12px; margin: 8px 0;" data-lang="zh"><code># å¥½çš„ï¼šåŒå‘å›ºå®šæ•ˆåº”
feols(outcome ~ x | country + year, data = df)

# ä¸å¥½çš„ï¼šä»…å•ä½å›ºå®šæ•ˆåº”ï¼ˆæ¼æ‰å…¨çƒè¶‹åŠ¿ï¼‰
feols(outcome ~ x | country, data = df)</code></pre>
  </div>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid var(--red);">
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="en">âŒ Mistake 4: Confusing Correlation with Causation</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="zh">âŒ é”™è¯¯4ï¼šæ··æ·†ç›¸å…³æ€§å’Œå› æœæ€§</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en">FE controls for unit-level confounders, but not time-varying confounders that affect only treated units. Example: countries might adopt trade liberalization in anticipation of growth â†’ growth causes the policy change, not vice versa. Use event study or robustness checks to validate causal claims.</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh">å›ºå®šæ•ˆåº”æ§åˆ¶å•ä½çº§æ··æ·†å› å­ï¼Œä½†ä¸æ˜¯ä»…å½±å“å¤„ç†å•ä½çš„æ—¶å˜æ··æ·†å› å­ã€‚ä¾‹å­ï¼šå›½å®¶å¯èƒ½å› æœŸæœ›å¢é•¿è€Œé‡‡å–è´¸æ˜“è‡ªç”±åŒ–â€”â€”å¢é•¿å¯¼è‡´æ”¿ç­–å˜åŒ–ï¼Œè€Œä¸æ˜¯åè¿‡æ¥ã€‚ä½¿ç”¨äº‹ä»¶ç ”ç©¶æˆ–ç¨³å¥æ€§æ£€æŸ¥æ¥éªŒè¯å› æœå£°æ˜ã€‚</p>
  </div>

  <div style="background: var(--parchment); padding: 24px; border-radius: 6px; border-left: 5px solid var(--red);">
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="en">âŒ Mistake 5: Wrong Standard Errors in Event Studies</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--ink); margin: 0 0 12px 0; font-weight: 600;" data-lang="zh">âŒ é”™è¯¯5ï¼šäº‹ä»¶ç ”ç©¶ä¸­çš„é”™è¯¯æ ‡å‡†è¯¯</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="en">In staggered event studies, cluster at the unit level (not time). Different treatment times mean observations aren't i.i.d. across time.</p>
    <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0; line-height: 1.6;" data-lang="zh">åœ¨é”™å¼€çš„äº‹ä»¶ç ”ç©¶ä¸­ï¼Œåœ¨å•ä½çº§åˆ«èšç±»ï¼ˆä¸æ˜¯æ—¶é—´ï¼‰ã€‚ä¸åŒçš„å¤„ç†æ—¶é—´æ„å‘³ç€è§‚æµ‹å€¼åœ¨æ—¶é—´ä¸Šä¸æ˜¯ç‹¬ç«‹åŒåˆ†å¸ƒçš„ã€‚</p>
  </div>
</section>

<!-- ============================================================================ -->
<!-- SECTION 5: DECISION FLOWCHART -->
<!-- ============================================================================ -->

<section style="margin-bottom: 40px;">
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="en">Section 5: Quick Decision Flowchart</h2>
  <h2 style="font-family: var(--serif); font-size: 28px; color: var(--ink); margin: 32px 0 20px 0; font-weight: 700;" data-lang="zh">ç¬¬äº”éƒ¨åˆ†ï¼šå¿«é€Ÿå†³ç­–æµç¨‹å›¾</h2>

  <div style="background: var(--cream); padding: 28px; border-radius: 6px; margin-bottom: 24px;">
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 20px 0;" data-lang="en">When to Use What?</h3>
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 20px 0;" data-lang="zh">ä»€ä¹ˆæ—¶å€™ç”¨ä»€ä¹ˆï¼Ÿ</h3>

    <div style="background: var(--parchment); padding: 16px; border-radius: 4px; margin-bottom: 16px;">
      <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0 0 10px 0; font-weight: 600;" data-lang="en">âœ… Use Fixed Effects (FE) when:</p>
      <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0 0 10px 0; font-weight: 600;" data-lang="zh">âœ… åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨å›ºå®šæ•ˆåº”ï¼ˆFEï¼‰ï¼š</p>
      <ul style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.8; margin: 0; padding-left: 24px;">
        <li data-lang="en">Unit characteristics (country, firm, school) might differ in unobserved ways <strong>and</strong> correlate with your predictors</li>
        <li data-lang="zh">å•ä½ç‰¹å¾ï¼ˆå›½å®¶ã€å…¬å¸ã€å­¦æ ¡ï¼‰å¯èƒ½ä»¥æœªè§‚å¯Ÿçš„æ–¹å¼ä¸åŒ<strong>å¹¶ä¸”</strong>ä¸ä½ çš„é¢„æµ‹å˜é‡ç›¸å…³</li>

        <li style="margin-top: 8px;" data-lang="en">You want within-unit causal effects (e.g., "what happens inside a country when trade openness changes")</li>
        <li style="margin-top: 8px;" data-lang="zh">ä½ æƒ³è¦å•ä½å†…å› æœæ•ˆåº”ï¼ˆä¾‹å¦‚ï¼Œ"å½“è´¸æ˜“å¼€æ”¾åº¦å˜åŒ–æ—¶ï¼Œä¸€ä¸ªå›½å®¶å†…ä¼šå‘ç”Ÿä»€ä¹ˆ"ï¼‰</li>

        <li style="margin-top: 8px;" data-lang="en"><strong>Default choice:</strong> When you're unsure between FE and RE, use FE. It's robust.</li>
        <li style="margin-top: 8px;" data-lang="zh"><strong>é»˜è®¤é€‰æ‹©ï¼š</strong>å½“ä½ ä¸ç¡®å®šå›ºå®šæ•ˆåº”å’Œéšæœºæ•ˆåº”æ—¶ï¼Œä½¿ç”¨å›ºå®šæ•ˆåº”ã€‚å®ƒæ˜¯ç¨³å¥çš„ã€‚</li>
      </ul>
    </div>

    <div style="background: var(--parchment); padding: 16px; border-radius: 4px; margin-bottom: 16px;">
      <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0 0 10px 0; font-weight: 600;" data-lang="en">âœ… Use Random Effects (RE) when:</p>
      <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0 0 10px 0; font-weight: 600;" data-lang="zh">âœ… åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨éšæœºæ•ˆåº”ï¼ˆREï¼‰ï¼š</p>
      <ul style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.8; margin: 0; padding-left: 24px;">
        <li data-lang="en">You have strong theoretical reasons to believe unit effects are uncorrelated with predictors</li>
        <li data-lang="zh">ä½ æœ‰å¼ºæœ‰åŠ›çš„ç†è®ºåŸå› ç›¸ä¿¡å•ä½æ•ˆåº”ä¸é¢„æµ‹å˜é‡æ— å…³</li>

        <li style="margin-top: 8px;" data-lang="en">You need to estimate effects of time-invariant variables (e.g., country culture, firm founding year)</li>
        <li style="margin-top: 8px;" data-lang="zh">ä½ éœ€è¦ä¼°è®¡ä¸éšæ—¶é—´å˜åŒ–å˜é‡çš„æ•ˆåº”ï¼ˆä¾‹å¦‚ï¼Œå›½å®¶æ–‡åŒ–ã€å…¬å¸åˆ›ç«‹å¹´ä»½ï¼‰</li>

        <li style="margin-top: 8px;" data-lang="en">You want between-unit effects (comparing units to each other, not to themselves over time)</li>
        <li style="margin-top: 8px;" data-lang="zh">ä½ æƒ³è¦å•ä½é—´æ•ˆåº”ï¼ˆæ¯”è¾ƒå•ä½ä¹‹é—´ï¼Œè€Œä¸æ˜¯å•ä½éšæ—¶é—´çš„è‡ªèº«ï¼‰</li>

        <li style="margin-top: 8px;" data-lang="en">Hausman test p-value > 0.05 (but don't rely on this alone)</li>
        <li style="margin-top: 8px;" data-lang="zh">Hausmanæ£€éªŒpå€¼> 0.05ï¼ˆä½†ä¸è¦ä»…ä¾èµ–è¿™ä¸ªï¼‰</li>
      </ul>
    </div>

    <div style="background: var(--parchment); padding: 16px; border-radius: 4px;">
      <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0 0 10px 0; font-weight: 600;" data-lang="en">ğŸš« Avoid Pooled OLS unless:</p>
      <p style="font-family: var(--sans); font-size: 14px; color: var(--ink); margin: 0 0 10px 0; font-weight: 600;" data-lang="zh">ğŸš« é™¤éä»¥ä¸‹æƒ…å†µï¼Œé¿å…æ±‡æ€»OLSï¼š</p>
      <ul style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.8; margin: 0; padding-left: 24px;">
        <li data-lang="en">You're just doing descriptive statistics or initial exploration</li>
        <li data-lang="zh">ä½ åªæ˜¯åœ¨åšæè¿°æ€§ç»Ÿè®¡æˆ–åˆå§‹æ¢ç´¢</li>

        <li style="margin-top: 8px;" data-lang="en">Unit effects are provably uncorrelated with X (rare in observational data)</li>
        <li style="margin-top: 8px;" data-lang="zh">å•ä½æ•ˆåº”å¯ä»¥è¯æ˜ä¸Xæ— å…³ï¼ˆåœ¨è§‚å¯Ÿæ•°æ®ä¸­å¾ˆå°‘è§ï¼‰</li>
      </ul>
    </div>
  </div>

  <div style="background: var(--parchment); padding: 28px; border-radius: 6px;">
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 20px 0;" data-lang="en">Standard Error Checklist</h3>
    <h3 style="font-family: var(--sans); font-size: 16px; color: var(--ink); font-weight: 600; margin: 0 0 20px 0;" data-lang="zh">æ ‡å‡†è¯¯æ£€æŸ¥æ¸…å•</h3>

    <ul style="font-family: var(--sans); font-size: 14px; color: var(--ink); line-height: 1.8; margin: 0; padding-left: 24px;">
      <li data-lang="en">â˜‘ï¸ Cluster at the unit level: <code style="background: var(--cream); padding: 2px 6px; border-radius: 2px;">cluster = ~unit_id</code></li>
      <li data-lang="zh">â˜‘ï¸ åœ¨å•ä½çº§åˆ«èšç±»: <code style="background: var(--cream); padding: 2px 6px; border-radius: 2px;">cluster = ~unit_id</code></li>

      <li style="margin-top: 10px;" data-lang="en">â˜‘ï¸ Use two-way FE (unit + time) unless you have a specific reason not to</li>
      <li style="margin-top: 10px;" data-lang="zh">â˜‘ï¸ é™¤éæœ‰ç‰¹å®šåŸå› ï¼Œå¦åˆ™ä½¿ç”¨åŒå‘å›ºå®šæ•ˆåº”ï¼ˆå•ä½+æ—¶é—´ï¼‰</li>

      <li style="margin-top: 10px;" data-lang="en">â˜‘ï¸ Always report with FE, even if RE or Pooled OLS seem reasonable</li>
      <li style="margin-top: 10px;" data-lang="zh">â˜‘ï¸ å³ä½¿éšæœºæ•ˆåº”æˆ–æ±‡æ€»OLSçœ‹èµ·æ¥åˆç†ï¼Œå§‹ç»ˆä½¿ç”¨å›ºå®šæ•ˆåº”æŠ¥å‘Š</li>

      <li style="margin-top: 10px;" data-lang="en">â˜‘ï¸ For staggered treatments, cluster at unit (not time)</li>
      <li style="margin-top: 10px;" data-lang="zh">â˜‘ï¸ å¯¹äºé”™å¼€çš„å¤„ç†ï¼Œåœ¨å•ä½çº§åˆ«èšç±»ï¼ˆä¸æ˜¯æ—¶é—´ï¼‰</li>
    </ul>
  </div>
</section>

<!-- ============================================================================ -->
<!-- FINAL INSIGHT BOX -->
<!-- ============================================================================ -->

<section style="margin-bottom: 32px;">
  <div style="background: linear-gradient(135deg, var(--gold) 0%, var(--warm) 100%); padding: 32px; border-radius: 6px; color: var(--cream);">
    <h2 style="font-family: var(--serif); font-size: 24px; color: var(--cream); margin: 0 0 16px 0; font-weight: 700;" data-lang="en">Key Takeaway</h2>
    <h2 style="font-family: var(--serif); font-size: 24px; color: var(--cream); margin: 0 0 16px 0; font-weight: 700;" data-lang="zh">å…³é”®è¦ç‚¹</h2>

    <p style="font-family: var(--sans); font-size: 15px; color: var(--cream); line-height: 1.8; margin: 0;" data-lang="en">Panel data with fixed effects is one of the most powerful tools in applied econometrics. By exploiting within-unit variation over time, you can identify causal effects even when units differ in unmeasured ways. Always remember: <strong>cluster your standard errors, include time fixed effects, and use FE as your default</strong>. Only switch to RE if you have strong theoretical justification.</p>
    <p style="font-family: var(--sans); font-size: 15px; color: var(--cream); line-height: 1.8; margin: 0;" data-lang="zh">å¸¦æœ‰å›ºå®šæ•ˆåº”çš„é¢æ¿æ•°æ®æ˜¯åº”ç”¨è®¡é‡ç»æµå­¦ä¸­æœ€å¼ºå¤§çš„å·¥å…·ä¹‹ä¸€ã€‚é€šè¿‡åœ¨æ—¶é—´ä¸Šåˆ©ç”¨å•ä½å†…å˜å¼‚ï¼Œå³ä½¿å•ä½åœ¨æœªæµ‹é‡çš„æ–¹å¼ä¸Šä¸åŒï¼Œä½ ä¹Ÿå¯ä»¥è¯†åˆ«å› æœæ•ˆåº”ã€‚æ°¸è¿œè®°ä½ï¼š<strong>èšç±»ä½ çš„æ ‡å‡†è¯¯ï¼ŒåŒ…æ‹¬æ—¶é—´å›ºå®šæ•ˆåº”ï¼Œå¹¶ä½¿ç”¨å›ºå®šæ•ˆåº”ä½œä¸ºä½ çš„é»˜è®¤</strong>ã€‚åªæœ‰åœ¨ä½ æœ‰å¼ºæœ‰åŠ›çš„ç†è®ºç†ç”±æ—¶æ‰åˆ‡æ¢åˆ°éšæœºæ•ˆåº”ã€‚</p>
  </div>
</section>

<!-- ============================================================================ -->
<!-- CHART.JS SIMULATOR SCRIPT -->
<!-- ============================================================================ -->

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Seed-based random number generator for reproducibility
function seededRandom(seed) {
  const x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
}

// Generate synthetic panel data
function generatePanelData(nUnits, tPeriods, corrUnitEffect) {
  const data = [];
  const trueEffect = 1.0;

  for (let i = 0; i < nUnits; i++) {
    // Unit-specific effect (correlated with X if corr > 0)
    const unitEffect = (Math.random() - 0.5) * 2;

    for (let t = 0; t < tPeriods; t++) {
      const x = Math.random();
      // Y = unitEffect + trueEffect*X + noise
      // Unit effect is correlated with X to degree 'corrUnitEffect'
      const xWithCorr = corrUnitEffect * unitEffect + Math.sqrt(1 - corrUnitEffect**2) * x;
      const noise = (Math.random() - 0.5) * 0.5;
      const y = unitEffect + trueEffect * xWithCorr + noise;

      data.push({ unit: i, time: t, x: xWithCorr, y: y, unitEffect: unitEffect });
    }
  }

  return data;
}

// Simple OLS estimation
function estimateOLS(data, useWithin = false) {
  let sumX = 0, sumY = 0, sumXX = 0, sumXY = 0, n = 0;

  if (useWithin) {
    // Demean within units
    const unitMeans = {};
    data.forEach(d => {
      if (!unitMeans[d.unit]) unitMeans[d.unit] = { sumX: 0, sumY: 0, count: 0 };
      unitMeans[d.unit].sumX += d.x;
      unitMeans[d.unit].sumY += d.y;
      unitMeans[d.unit].count++;
    });

    Object.keys(unitMeans).forEach(u => {
      unitMeans[u].meanX = unitMeans[u].sumX / unitMeans[u].count;
      unitMeans[u].meanY = unitMeans[u].sumY / unitMeans[u].count;
    });

    data.forEach(d => {
      const xDemeaned = d.x - unitMeans[d.unit].meanX;
      const yDemeaned = d.y - unitMeans[d.unit].meanY;
      sumX += xDemeaned;
      sumY += yDemeaned;
      sumXX += xDemeaned * xDemeaned;
      sumXY += xDemeaned * yDemeaned;
      n++;
    });
  } else {
    // Regular OLS
    data.forEach(d => {
      sumX += d.x;
      sumY += d.y;
      sumXX += d.x * d.x;
      sumXY += d.x * d.y;
      n++;
    });
  }

  const meanX = sumX / n;
  const meanY = sumY / n;
  const slope = (sumXY - n * meanX * meanY) / (sumXX - n * meanX * meanX);

  return slope;
}

// Simulator state
let chart = null;

// Update slider values and regenerate
document.getElementById('nUnitsSlider').addEventListener('input', (e) => {
  document.getElementById('nUnitsValue').textContent = e.target.value;
  document.getElementById('nUnitsValue_zh').textContent = e.target.value;
  runSimulation();
});

document.getElementById('tPeriodsSlider').addEventListener('input', (e) => {
  document.getElementById('tPeriodsValue').textContent = e.target.value;
  document.getElementById('tPeriodsValue_zh').textContent = e.target.value;
  runSimulation();
});

document.getElementById('corrSlider').addEventListener('input', (e) => {
  const corrValue = (parseFloat(e.target.value)).toFixed(1);
  document.getElementById('corrValue').textContent = corrValue;
  document.getElementById('corrValue_zh').textContent = corrValue;
  runSimulation();
});

document.getElementById('generateBtn').addEventListener('click', runSimulation);
document.getElementById('generateBtn_zh').addEventListener('click', runSimulation);

function runSimulation() {
  const nUnits = parseInt(document.getElementById('nUnitsSlider').value);
  const tPeriods = parseInt(document.getElementById('tPeriodsSlider').value);
  const correlation = parseFloat(document.getElementById('corrSlider').value);

  // Generate data
  const data = generatePanelData(nUnits, tPeriods, correlation);

  // Estimate models
  const pooledCoef = estimateOLS(data, false);
  const feCoef = estimateOLS(data, true);
  // For RE, approximate as weighted average (simplified)
  const reCoef = (pooledCoef * 0.4 + feCoef * 0.6);

  // Update chart
  updateChart([feCoef, pooledCoef, reCoef]);
}

function updateChart(estimates) {
  const ctx = document.getElementById('simulatorChart').getContext('2d');

  if (chart) {
    chart.destroy();
  }

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Fixed Effects', 'Pooled OLS', 'Random Effects'],
      datasets: [{
        label: 'Estimated Coefficient',
        data: estimates,
        backgroundColor: ['#6B9080', '#D4A574', '#A68968'],
        borderColor: '#2C3E35',
        borderWidth: 1.5
      }, {
        label: 'True Effect',
        type: 'line',
        data: [1.0, 1.0, 1.0],
        borderColor: '#000',
        borderDash: [5, 5],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      indexAxis: 'x',
      plugins: {
        legend: {
          display: true,
          labels: {
            font: { family: 'system-ui, -apple-system', size: 13 },
            color: '#2C3E35'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: -0.2,
          max: 2.2,
          ticks: {
            font: { family: 'system-ui, -apple-system', size: 12 }
          },
          title: {
            display: true,
            text: 'Coefficient Value',
            font: { family: 'system-ui, -apple-system', size: 12 }
          }
        },
        x: {
          ticks: {
            font: { family: 'system-ui, -apple-system', size: 12 }
          }
        }
      }
    }
  });
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', runSimulation);
</script>
