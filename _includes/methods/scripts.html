<script>
/* ── Language init (English only) ──────────────────── */
window.addEventListener('DOMContentLoaded', function() {
  document.body.className = 'en';
  buildPageTOC();
});

/* ── Right-side TOC ────────────────────────────────── */
function buildPageTOC() {
  var content = document.querySelector('.content');
  var main    = document.querySelector('.main');
  if (!content || !main) return;

  var topbarH = 60;
  var items = [];
  var autoId = 0;

  content.querySelectorAll('h2, h3').forEach(function(h) {
    var level  = h.tagName === 'H2' ? 2 : 3;
    var anchorId = 'toc-' + (autoId++);
    var text = h.textContent.trim();

    var anchor = document.createElement('span');
    anchor.id = anchorId;
    anchor.setAttribute('aria-hidden', 'true');
    anchor.style.cssText = 'display:block;position:relative;top:-' + (topbarH + 8) + 'px;visibility:hidden;pointer-events:none;height:0';
    h.parentNode.insertBefore(anchor, h);

    items.push({ id: anchorId, text: text, level: level });
  });

  if (items.length === 0) return;

  var toc = document.createElement('nav');
  toc.className = 'page-toc';
  toc.innerHTML = '<div class="toc-label">Contents</div>';

  var ul = document.createElement('ul');
  ul.className = 'toc-list';
  items.forEach(function(item) {
    var li = document.createElement('li');
    li.className = 'toc-item toc-h' + item.level;
    li.dataset.id = item.id;
    var a = document.createElement('a');
    a.href = '#' + item.id;
    a.textContent = item.text;
    li.appendChild(a);
    ul.appendChild(li);
  });
  toc.appendChild(ul);
  main.appendChild(toc);

  // IntersectionObserver — highlight active item
  var tocItems = ul.querySelectorAll('.toc-item');
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        var id = entry.target.id;
        tocItems.forEach(function(li) {
          li.classList.toggle('active', li.dataset.id === id);
        });
      }
    });
  }, { rootMargin: '-5% 0px -85% 0px', threshold: 0 });

  items.forEach(function(item) {
    var el = document.getElementById(item.id);
    if (el) observer.observe(el);
  });
}
</script>
